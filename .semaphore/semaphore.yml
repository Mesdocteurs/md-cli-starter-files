version: v1.0
name: Install & Test
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: 'Install'
    task:
      secrets:
        - name: staging-keys
        - name: tokens
      jobs:
        - name: 'Install & cache dependencies'
          commands:
#             Cache node_modules of the API
            - chmod 600 /home/semaphore/.ssh/id_rsa
            - git clone -b develop --single-branch git@github.com:Mesdocteurs/md-api.git
            - cd md-api
            - cache restore node-modules-api-$(checksum package.json)
            - npm i
            - cache store node-modules-api-$(checksum package.json) node_modules
            - cd ..
#             Creating PROJECT_NAME var containing the current project
            - checkout
            - export PROJECT_NAME=`basename "$PWD"`
#             Storing node_modules
            - cache restore node-modules-$(checksum package.json)
            - npm i
            - cache store node-modules-$(checksum package.json) node_modules
#             Storing the name of the project for further use
            - echo ${PROJECT_NAME} > project-name
            - cache store project-name project-name
  - name: 'Lint & Unit tests'
    task:
      prologue:
        commands:
          - sem-version node 12.13.0
          - checkout
          - npm i -g @angular/cli
          - cache restore node-modules-$(checksum package.json)
      jobs:
        - name: 'Lint'
          commands:
            - ng lint
        - name: 'Unit tests'
          commands:
            - ng test --watch=false --progress=false
#  - name: 'E2E tests'
#    task:
#      secrets:
#        - name: staging-keys
#        - name: tokens
#      prologue:
#        commands:
#          - sem-version node 12.13.0
#          - chmod 600 /home/semaphore/.ssh/id_rsa
#          - sem-service start redis
#          - sem-service start postgres
#          - npm i -g @angular/cli
#          - sudo apt-get -y install xvfb libgtk2.0-0 libnotify-dev libgconf-2-4 libnss3 libxss1 libasound2 # install missing libs for cypress
#          - git clone -b develop --single-branch git@github.com:Mesdocteurs/md-api.git
#          - cd md-api
#          - cache restore node-modules-api-$(checksum package.json)
#          - createdb -U postgres -h 0.0.0.0 mesdocteurs
#          - node server/server.js &
#          - sleep 15
#      jobs:
#        - name: 'Integration tests'
#          commands:
#            - cd ..
#            - checkout
#            - cache restore node-modules-$(checksum package.json)
#            - npx cypress install # install cypress binary that is not cached
#            - npm run cy:test
promotions:
  - name: '1 - Recette deployment'
    pipeline_file: recette-deploy.yml
    auto_promote_on:
      - result: passed
        branch:
          - develop
  - name: '2 - Preprod deployment'
    pipeline_file: preprod-deploy.yml
    auto_promote_on:
      - result: passed
        branch:
          - master
  - name: '3 - PRODUCTION deployment'
    pipeline_file: production-deploy.yml
