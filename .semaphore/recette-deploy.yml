version: v1.0
name: Recette deployment
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: 'Build'
    task:
      env_vars:
        - name: ENVIRONMENT
          value: 'recette'
      jobs:
        - name: 'Build & cache project'
          commands:
#             Building the project for recette
            - checkout
            - npm i -g @angular/cli@7.3.9
            - cache restore node-modules-$(checksum package.json)
            - ng build --configuration=${ENVIRONMENT}
#            Restoring the project name from cache
            - cache restore project-name
            - export PROJECT_NAME=`cat project-name`
            - export PROJECT_VERSION=${PROJECT_NAME}_version_`date +%Y%m%d_%H%M%S%3N`
#            Renaming and caching for further use
            - mv dist/${PROJECT_NAME} dist/${PROJECT_VERSION}
            - cache delete ${PROJECT_NAME}-${ENVIRONMENT}
            - cache store ${PROJECT_NAME}-${ENVIRONMENT} dist/${PROJECT_VERSION}
  - name: 'Copy files to the gateway'
    task:
      env_vars:
        - name: ENVIRONMENT
          value: 'recette'
      secrets:
        - name: ip
        - name: staging-keys
      jobs:
        - name: 'Copy files'
          commands:
            - chmod 600 /home/semaphore/.ssh/id_rsa
            - checkout
            - cd ..
#             Restore project name and built project from cache
            - cache restore project-name
            - export PROJECT_NAME=`cat project-name`
            - cache restore ${PROJECT_NAME}-${ENVIRONMENT}
#             Replace private key
            - chmod 600 /home/semaphore/.ssh/id_rsa.preprod
            - mv -f /home/semaphore/.ssh/id_rsa.preprod /home/semaphore/.ssh/id_rsa
            - ssh-keyscan -H -p 22 ${IPADDR_STAGING} >> /home/semaphore/.ssh/known_hosts
#             Create PROJECT_VERSION var
            - cd dist/
            - export PROJECT_VERSION=`ls`
#             Copying the project to the gateway (staging)
            - tar zcf ${PROJECT_VERSION}.tar.gz ${PROJECT_VERSION}/
            - scp -r ${PROJECT_VERSION}.tar.gz mdc@${IPADDR_STAGING}:${STAGING_TMP_DIR}/${PROJECT_VERSION}.tar.gz
  - name: 'Deploy to recette'
    task:
      secrets:
        - name: ip
        - name: staging-keys
      env_vars:
        - name: ENVIRONMENT
          value: 'recette'
      jobs:
        - name: 'Deploy'
          commands:
#             Restore project name and built project from cache
            - cache restore project-name
            - export PROJECT_NAME=`cat project-name`
            - cache restore ${PROJECT_NAME}-${ENVIRONMENT}
#             Create PROJECT_VERSION var
            - cd dist/
            - export PROJECT_VERSION=`ls`
#             Replace private key
            - chmod 600 /home/semaphore/.ssh/id_rsa.preprod
            - mv -f /home/semaphore/.ssh/id_rsa.preprod /home/semaphore/.ssh/id_rsa
            - ssh-keyscan -H -p 22 ${IPADDR_STAGING} >> /home/semaphore/.ssh/known_hosts
#             Start deploy script
            - ssh mdc@${IPADDR_STAGING} "cd deployment-scripts && git pull"
            - ssh mdc@${IPADDR_STAGING} "bash deployment-scripts/mesDocteurs/staging/deploy.sh ${PROJECT_VERSION} ${IPADDR_RECETTE_PRIVATE}"
            - ssh mdc@${IPADDR_STAGING} "rm -f ${STAGING_TMP_DIR}/${PROJECT_VERSION}.tar.gz"
